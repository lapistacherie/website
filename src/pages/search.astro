---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ProductCard from '../components/ProductCard.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL;

// Get all products for client-side search
const allProducts = await getCollection('products');
---

<Layout title="Search - La Pistacherie">
  <Header />

  <main class="py-16 min-h-screen">
    <div class="container mx-auto px-4 max-w-7xl">
      <h1 class="text-4xl font-bold text-center mb-8">Search Products</h1>

      <!-- Search Input -->
      <div class="max-w-2xl mx-auto mb-12">
        <input
          type="text"
          id="search-input"
          placeholder="Search for products..."
          class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#39441E] focus:border-transparent outline-none"
        />
      </div>

      <!-- Search Results -->
      <div id="search-results">
        <p class="text-center text-gray-500 text-lg">
          Enter a search term to find products
        </p>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script define:vars={{ allProducts, base }}>
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');

  function renderResults(products) {
    if (products.length === 0) {
      searchResults.innerHTML = `
        <p class="text-center text-gray-500 text-lg">
          No products found matching your search
        </p>
      `;
      return;
    }

    const resultsHTML = `
      <div class="mb-6">
        <p class="text-gray-600 text-center">
          Found ${products.length} product${products.length === 1 ? '' : 's'}
        </p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        ${products.map(product => {
          const hasVariants = product.data.variants && product.data.variants.length > 0;
          const imagePath = `${base}/images/products/${product.data.category}/${product.data.images[0]}`;
          const priceText = hasVariants ? 'From ' : '';
          const formattedPrice = product.data.price.toFixed(2);

          return `
          <a href="${base}/products/${product.data.category}/${product.slug}" class="bg-white flex flex-col rounded-lg overflow-hidden border border-[#D4AF37]/30 shadow-sm hover:shadow-[0_8px_30px_rgb(212,175,55,0.15)] hover:border-[#D4AF37] transition-all duration-300">
            <div class="relative aspect-square bg-gray-200">
              <img
                src="${imagePath}"
                alt="${product.data.title}"
                class="w-full h-full object-cover"
              />
              ${product.data.featured ? '<span class="absolute top-2 right-2 bg-[#D4AF37] text-white text-xs px-2 py-1 rounded">Featured</span>' : ''}
            </div>
            <div class="p-4 grow flex flex-col justify-between">
              <div>
                <div class="text-xs text-gray-400 font-medium uppercase tracking-widest mb-1">
                  ${product.data.category.replace('-', ' ')}
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4 line-clamp-2">
                  ${product.data.title}
                </h3>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-lg font-semibold text-[#39441E]">
                  ${priceText}₹${formattedPrice}
                </span>
                <span class="text-sm text-gray-500 hover:text-[#39441E] transition-colors">
                  View Details →
                </span>
              </div>
            </div>
          </a>
        `;
        }).join('')}
      </div>
    `;
    searchResults.innerHTML = resultsHTML;
  }

  function performSearch(query) {
    if (!query || query.trim() === '') {
      searchResults.innerHTML = `
        <p class="text-center text-gray-500 text-lg">
          Enter a search term to find products
        </p>
      `;
      return;
    }

    const lowerQuery = query.toLowerCase().trim();
    const filtered = allProducts.filter(product => {
      const title = product.data.title.toLowerCase();
      const category = product.data.category.toLowerCase();
      const tags = product.data.tags ? product.data.tags.join(' ').toLowerCase() : '';

      return title.includes(lowerQuery) ||
             category.includes(lowerQuery) ||
             tags.includes(lowerQuery);
    });

    renderResults(filtered);
  }

  // Search on input
  let debounceTimer;
  searchInput.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      performSearch(e.target.value);
    }, 300);
  });

  // Check for URL search parameter on load
  window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('q');
    if (searchQuery) {
      searchInput.value = searchQuery;
      performSearch(searchQuery);
    }
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
